name: Release Extension

on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é…è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v1.0.0, v2.1.3

jobs:
  release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º release
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run linting
        run: npm run lint
        
      - name: Compile TypeScript
        run: npm run compile
        
      - name: Run tests
        run: npm test
        continue-on-error: true  # å³ä½¿æµ‹è¯•å¤±è´¥ä¹Ÿç»§ç»­ï¼Œä½†ä¼šåœ¨æ—¥å¿—ä¸­æ˜¾ç¤º
        
      - name: Install vsce
        run: npm install -g @vscode/vsce
        
      - name: Package extension
        run: npm run package
        
      - name: Get package info
        id: package
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "filename=$PACKAGE_NAME-$PACKAGE_VERSION.vsix" >> $GITHUB_OUTPUT
          
      - name: Verify package file exists
        run: |
          if [ ! -f "${{ steps.package.outputs.filename }}" ]; then
            echo "Package file not found: ${{ steps.package.outputs.filename }}"
            ls -la *.vsix || echo "No .vsix files found"
            exit 1
          fi
          echo "Package file verified: ${{ steps.package.outputs.filename }}"
          
      - name: Extract tag version
        id: tag
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "Tag version: $TAG_VERSION"
          
      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ðŸš€ Release ${{ steps.tag.outputs.version }}
          
          ### ðŸ“¦ å®‰è£…æ–¹å¼
          
          1. **ç›´æŽ¥ä¸‹è½½å®‰è£…**ï¼š
             - ä¸‹è½½ä¸‹æ–¹çš„ `.vsix` æ–‡ä»¶
             - åœ¨ VS Code ä¸­æŒ‰ `Ctrl+Shift+P` (Windows/Linux) æˆ– `Cmd+Shift+P` (Mac)
             - è¾“å…¥ "Extensions: Install from VSIX..."
             - é€‰æ‹©ä¸‹è½½çš„ `.vsix` æ–‡ä»¶è¿›è¡Œå®‰è£…
          
          2. **å‘½ä»¤è¡Œå®‰è£…**ï¼š
             ```bash
             code --install-extension ${{ steps.package.outputs.filename }}
             ```
          
          ### ðŸ“‹ æ‰©å±•ä¿¡æ¯
          - **æ‰©å±•åç§°**: ${{ steps.package.outputs.name }}
          - **ç‰ˆæœ¬**: ${{ steps.package.outputs.version }}
          - **æ–‡ä»¶å¤§å°**: $(du -h ${{ steps.package.outputs.filename }} | cut -f1)
          
          ### ðŸ”§ ç³»ç»Ÿè¦æ±‚
          - VS Code ç‰ˆæœ¬: >= 1.74.0
          - Node.js ç‰ˆæœ¬: >= 18.0.0
          
          ---
          
          > ðŸ’¡ å¦‚æžœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) ä¸­åé¦ˆã€‚
          EOF
          
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.version }}
          name: "Release ${{ steps.tag.outputs.version }}"
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.tag.outputs.version, '-') }}  # å¦‚æžœç‰ˆæœ¬åŒ…å« '-' åˆ™æ ‡è®°ä¸ºé¢„å‘å¸ƒ
          files: |
            ${{ steps.package.outputs.filename }}
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: extension-package-${{ steps.tag.outputs.version }}
          path: |
            ${{ steps.package.outputs.filename }}
            release_notes.md
          retention-days: 30
          
      - name: Summary
        run: |
          echo "## ðŸŽ‰ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Extension packaged successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Package Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- Name: \`${{ steps.package.outputs.name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Version: \`${{ steps.package.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- File: \`${{ steps.package.outputs.filename }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Size: \`$(du -h ${{ steps.package.outputs.filename }} | cut -f1)\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Release URL:** [${{ steps.tag.outputs.version }}](${{ steps.create_release.outputs.url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Installation:** Users can now download and install the extension from the release page!" >> $GITHUB_STEP_SUMMARY